{%- comment -%}
  Search Modal with Predictive Search
{%- endcomment -%}

<search-modal class="search-modal" aria-hidden="true">
  <div class="search-modal__overlay" data-close></div>
  <div class="search-modal__container" role="dialog" aria-modal="true" aria-label="{{ 'general.search.search' | t }}">
    
    <div class="search-modal__header">
      <form action="{{ routes.search_url }}" method="get" role="search" class="search-modal__form">
        <label for="SearchModalInput" class="visually-hidden">{{ 'general.search.search' | t }}</label>
        <div class="search-modal__input-wrapper">
          <span class="search-modal__icon">
            {%- render 'icon-search' -%}
          </span>
          <input
            type="search"
            id="SearchModalInput"
            name="q"
            class="search-modal__input"
            placeholder="{{ 'general.search.placeholder' | t }}"
            autocomplete="off"
            autocorrect="off"
            autocapitalize="off"
            spellcheck="false"
          >
          <button type="button" class="search-modal__clear" aria-label="{{ 'general.search.clear' | t }}" hidden>
            {%- render 'icon-close' -%}
          </button>
        </div>
        <button type="submit" class="search-modal__submit button" aria-label="{{ 'general.search.search' | t }}">
          {{ 'general.search.search' | t }}
        </button>
      </form>
      <button type="button" class="search-modal__close" data-close aria-label="{{ 'accessibility.close' | t }}">
        {%- render 'icon-close' -%}
      </button>
    </div>

    <div class="search-modal__content">
      <div class="search-modal__results" hidden>
        {%- comment -%} Results will be injected here {%- endcomment -%}
      </div>
      
      <div class="search-modal__default">
        {%- if settings.search_show_trending -%}
          <div class="search-modal__section">
            <h3 class="search-modal__section-title">{{ 'general.search.trending' | t }}</h3>
            <ul class="search-modal__suggestions">
              {%- assign trending = settings.search_trending | split: ',' -%}
              {%- for term in trending limit: 5 -%}
                <li>
                  <a href="{{ routes.search_url }}?q={{ term | strip | url_encode }}" class="search-modal__suggestion">
                    {%- render 'icon-trending' -%}
                    {{ term | strip }}
                  </a>
                </li>
              {%- endfor -%}
            </ul>
          </div>
        {%- endif -%}

        {%- if settings.search_show_collections -%}
          <div class="search-modal__section">
            <h3 class="search-modal__section-title">{{ 'general.search.popular_collections' | t }}</h3>
            <div class="search-modal__collections">
              {%- for collection in collections limit: 4 -%}
                {%- if collection.products_count > 0 -%}
                  <a href="{{ collection.url }}" class="search-modal__collection">
                    {%- if collection.image != blank -%}
                      <div class="search-modal__collection-image">
                        {{ collection.image | image_url: width: 100 | image_tag: loading: 'lazy' }}
                      </div>
                    {%- endif -%}
                    <span>{{ collection.title }}</span>
                  </a>
                {%- endif -%}
              {%- endfor -%}
            </div>
          </div>
        {%- endif -%}
      </div>
    </div>
    
  </div>
</search-modal>

<style>
.search-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1001;
  visibility: hidden;
  pointer-events: none;
}

.search-modal.is-open {
  visibility: visible;
  pointer-events: auto;
}

.search-modal__overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.search-modal.is-open .search-modal__overlay {
  opacity: 1;
}

.search-modal__container {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  max-height: 90vh;
  background: var(--color-background);
  transform: translateY(-100%);
  transition: transform 0.3s ease;
  display: flex;
  flex-direction: column;
}

.search-modal.is-open .search-modal__container {
  transform: translateY(0);
}

/* Header */
.search-modal__header {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem var(--grid-gap);
  border-bottom: 1px solid var(--color-border);
}

.search-modal__form {
  flex: 1;
  display: flex;
  gap: 0.75rem;
}

.search-modal__input-wrapper {
  flex: 1;
  position: relative;
  display: flex;
  align-items: center;
}

.search-modal__icon {
  position: absolute;
  left: 1rem;
  display: flex;
  color: var(--color-text-secondary);
}

.search-modal__icon svg {
  width: 20px;
  height: 20px;
}

.search-modal__input {
  width: 100%;
  height: 48px;
  padding: 0 3rem;
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius);
  font-size: 1rem;
  background: var(--color-background-secondary);
}

.search-modal__input:focus {
  outline: none;
  border-color: var(--color-primary);
  background: var(--color-background);
}

.search-modal__clear {
  position: absolute;
  right: 0.75rem;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 28px;
  height: 28px;
  background: var(--color-background-tertiary);
  border: none;
  border-radius: 50%;
  cursor: pointer;
}

.search-modal__clear svg {
  width: 14px;
  height: 14px;
}

.search-modal__submit {
  height: 48px;
  padding: 0 1.5rem;
}

.search-modal__close {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 44px;
  height: 44px;
  background: none;
  border: none;
  cursor: pointer;
  color: var(--color-text);
}

.search-modal__close svg {
  width: 24px;
  height: 24px;
}

/* Content */
.search-modal__content {
  flex: 1;
  overflow-y: auto;
  padding: 1.5rem var(--grid-gap);
  max-height: calc(90vh - 80px);
}

/* Default content (trending, collections) */
.search-modal__section {
  margin-bottom: 2rem;
}

.search-modal__section:last-child {
  margin-bottom: 0;
}

.search-modal__section-title {
  font-size: 0.875rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--color-text-secondary);
  margin-bottom: 1rem;
}

.search-modal__suggestions {
  list-style: none;
  margin: 0;
  padding: 0;
}

.search-modal__suggestion {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  padding: 0.75rem 0;
  color: var(--color-text);
  text-decoration: none;
  border-bottom: 1px solid var(--color-border);
  transition: color 0.2s ease;
}

.search-modal__suggestion:hover {
  color: var(--color-primary);
}

.search-modal__suggestion svg {
  width: 18px;
  height: 18px;
  color: var(--color-text-secondary);
}

.search-modal__collections {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
  gap: 1rem;
}

.search-modal__collection {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 0.75rem;
  padding: 1rem;
  background: var(--color-background-secondary);
  border-radius: var(--border-radius);
  text-decoration: none;
  color: var(--color-text);
  text-align: center;
  transition: all 0.2s ease;
}

.search-modal__collection:hover {
  background: var(--color-background-tertiary);
  transform: translateY(-2px);
}

.search-modal__collection-image {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  overflow: hidden;
}

.search-modal__collection-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* Results */
.search-modal__results-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 1rem;
  padding-bottom: 1rem;
  border-bottom: 1px solid var(--color-border);
}

.search-modal__results-title {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
}

.search-modal__view-all {
  color: var(--color-primary);
  text-decoration: underline;
}

.search-modal__results-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1.5rem;
}

.search-modal__result-item {
  display: flex;
  gap: 1rem;
  text-decoration: none;
  color: var(--color-text);
}

.search-modal__result-image {
  flex-shrink: 0;
  width: 80px;
  height: 80px;
  border-radius: var(--border-radius);
  overflow: hidden;
  background: var(--color-background-secondary);
}

.search-modal__result-image img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.search-modal__result-info {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 0.25rem;
}

.search-modal__result-title {
  font-weight: 500;
  line-height: 1.3;
}

.search-modal__result-price {
  font-weight: 600;
  color: var(--color-heading);
}

.search-modal__no-results {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--color-text-secondary);
}

.search-modal__loading {
  display: flex;
  justify-content: center;
  padding: 2rem;
}

.search-modal__loading svg {
  width: 30px;
  height: 30px;
  animation: spin 1s linear infinite;
}

@media (prefers-reduced-motion: reduce) {
  .search-modal__overlay,
  .search-modal__container {
    transition: none;
  }
}
</style>

<script>
  if (!customElements.get('search-modal')) {
    class SearchModal extends HTMLElement {
      constructor() {
        super();
        this.overlay = this.querySelector('.search-modal__overlay');
        this.closeButton = this.querySelector('.search-modal__close');
        this.input = this.querySelector('.search-modal__input');
        this.clearButton = this.querySelector('.search-modal__clear');
        this.results = this.querySelector('.search-modal__results');
        this.defaultContent = this.querySelector('.search-modal__default');
        this.form = this.querySelector('.search-modal__form');
        
        this.searchTimeout = null;
        this.minChars = 2;
        
        this.bindEvents();
      }

      bindEvents() {
        this.overlay.addEventListener('click', () => this.close());
        this.closeButton.addEventListener('click', () => this.close());
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.classList.contains('is-open')) {
            this.close();
          }
        });

        this.input.addEventListener('input', () => {
          this.handleInput();
        });

        this.clearButton.addEventListener('click', () => {
          this.input.value = '';
          this.clearButton.hidden = true;
          this.showDefault();
          this.input.focus();
        });
      }

      open() {
        this.classList.add('is-open');
        this.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';
        
        setTimeout(() => {
          this.input.focus();
        }, 100);
      }

      close() {
        this.classList.remove('is-open');
        this.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        this.input.value = '';
        this.clearButton.hidden = true;
        this.showDefault();
      }

      handleInput() {
        const query = this.input.value.trim();
        this.clearButton.hidden = query.length === 0;
        
        clearTimeout(this.searchTimeout);
        
        if (query.length < this.minChars) {
          this.showDefault();
          return;
        }

        this.searchTimeout = setTimeout(() => {
          this.performSearch(query);
        }, 300);
      }

      async performSearch(query) {
        this.results.innerHTML = `
          <div class="search-modal__loading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/>
            </svg>
          </div>
        `;
        this.results.hidden = false;
        this.defaultContent.hidden = true;

        try {
          const response = await fetch(
            `${window.Lumina.routes.predictiveSearch}?q=${encodeURIComponent(query)}&resources[type]=product,collection,article&resources[limit]=6&section_id=predictive-search`
          );
          
          if (!response.ok) throw new Error('Search failed');
          
          const text = await response.text();
          const html = new DOMParser().parseFromString(text, 'text/html');
          const resultsMarkup = html.querySelector('#shopify-section-predictive-search')?.innerHTML;
          
          if (resultsMarkup) {
            this.results.innerHTML = resultsMarkup;
          } else {
            this.results.innerHTML = `<div class="search-modal__no-results">No results found for "${query}"</div>`;
          }
        } catch (error) {
          console.error('Search error:', error);
          this.results.innerHTML = `<div class="search-modal__no-results">Error performing search</div>`;
        }
      }

      showDefault() {
        this.results.hidden = true;
        this.defaultContent.hidden = false;
      }
    }
    customElements.define('search-modal', SearchModal);
  }

  // Global function to open search
  window.openSearch = function() {
    const modal = document.querySelector('search-modal');
    if (modal) {
      modal.open();
    }
  };
</script>
