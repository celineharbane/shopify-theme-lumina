{%- comment -%}
  Quick View Modal
  Dynamically loads product content via AJAX
{%- endcomment -%}

<quick-view-modal class="quick-view-modal" aria-hidden="true">
  <div class="quick-view-modal__overlay" data-close></div>
  <div class="quick-view-modal__container" role="dialog" aria-modal="true" aria-label="{{ 'products.product.quick_view' | t }}">
    <button type="button" class="quick-view-modal__close" data-close aria-label="{{ 'accessibility.close' | t }}">
      {%- render 'icon-close' -%}
    </button>
    <div class="quick-view-modal__content">
      <div class="quick-view-modal__loading">
        {%- render 'icon-spinner' -%}
      </div>
    </div>
  </div>
</quick-view-modal>

<style>
.quick-view-modal {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1000;
  display: flex;
  align-items: center;
  justify-content: center;
  padding: var(--grid-gap);
  visibility: hidden;
  pointer-events: none;
}

.quick-view-modal.is-open {
  visibility: visible;
  pointer-events: auto;
}

.quick-view-modal__overlay {
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.quick-view-modal.is-open .quick-view-modal__overlay {
  opacity: 1;
}

.quick-view-modal__container {
  position: relative;
  max-width: 1000px;
  width: 100%;
  max-height: 90vh;
  background: var(--color-background);
  border-radius: var(--border-radius-large);
  overflow: hidden;
  transform: translateY(20px) scale(0.95);
  opacity: 0;
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.quick-view-modal.is-open .quick-view-modal__container {
  transform: translateY(0) scale(1);
  opacity: 1;
}

.quick-view-modal__close {
  position: absolute;
  top: 1rem;
  right: 1rem;
  z-index: 10;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 40px;
  height: 40px;
  background: var(--color-background);
  border: none;
  border-radius: 50%;
  cursor: pointer;
  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
  transition: all 0.2s ease;
}

.quick-view-modal__close:hover {
  background: var(--color-primary);
  color: var(--color-background);
}

.quick-view-modal__close svg {
  width: 20px;
  height: 20px;
}

.quick-view-modal__content {
  max-height: 90vh;
  overflow-y: auto;
  overscroll-behavior: contain;
}

.quick-view-modal__loading {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
}

.quick-view-modal__loading svg {
  width: 40px;
  height: 40px;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  from { transform: rotate(0deg); }
  to { transform: rotate(360deg); }
}

/* Quick View Product Layout */
.quick-view-product {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--grid-gap);
}

@media (min-width: 750px) {
  .quick-view-product {
    grid-template-columns: 1fr 1fr;
  }
}

.quick-view-product__media {
  position: relative;
  aspect-ratio: 1/1;
}

.quick-view-product__media img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.quick-view-product__info {
  padding: 1.5rem;
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

@media (min-width: 750px) {
  .quick-view-product__info {
    padding: 2rem;
    overflow-y: auto;
    max-height: calc(90vh - 4rem);
  }
}

.quick-view-product__vendor {
  font-size: 0.875rem;
  color: var(--color-text-secondary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.quick-view-product__title {
  font-size: 1.5rem;
  margin: 0;
  line-height: 1.3;
}

.quick-view-product__price {
  display: flex;
  align-items: center;
  gap: 0.75rem;
  font-size: 1.25rem;
  font-weight: 600;
}

.quick-view-product__price--sale .quick-view-product__price-regular {
  text-decoration: line-through;
  color: var(--color-text-secondary);
  font-weight: 400;
}

.quick-view-product__price-current {
  color: var(--color-sale);
}

.quick-view-product__description {
  color: var(--color-text-secondary);
  line-height: 1.6;
}

.quick-view-product__form {
  display: flex;
  flex-direction: column;
  gap: 1rem;
  margin-top: auto;
}

.quick-view-product__options {
  display: flex;
  flex-direction: column;
  gap: 1rem;
}

.quick-view-product__option-label {
  display: block;
  font-weight: 500;
  margin-bottom: 0.5rem;
}

.quick-view-product__option-values {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
}

.quick-view-product__view-full {
  text-align: center;
  padding-top: 1rem;
  border-top: 1px solid var(--color-border);
}

.quick-view-product__view-full a {
  color: var(--color-primary);
  text-decoration: underline;
}

@media (prefers-reduced-motion: reduce) {
  .quick-view-modal__overlay,
  .quick-view-modal__container {
    transition: none;
  }

  .quick-view-modal__loading svg {
    animation: none;
  }
}
</style>

<script>
  if (!customElements.get('quick-view-modal')) {
    class QuickViewModal extends HTMLElement {
      constructor() {
        super();
        this.overlay = this.querySelector('[data-close]');
        this.closeButtons = this.querySelectorAll('[data-close]');
        this.content = this.querySelector('.quick-view-modal__content');
        
        this.closeButtons.forEach(btn => {
          btn.addEventListener('click', () => this.close());
        });
        
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape' && this.classList.contains('is-open')) {
            this.close();
          }
        });
      }

      showLoading() {
        this.classList.add('is-open');
        this.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        this.content.innerHTML = `
          <div class="quick-view-modal__loading">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/>
            </svg>
          </div>
        `;
      }

      show(htmlContent) {
        this.classList.add('is-open');
        this.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        this.content.innerHTML = htmlContent;

        // Initialize any product forms or variant pickers
        const productForm = this.content.querySelector('product-form');
        if (productForm && productForm.connectedCallback) {
          productForm.connectedCallback();
        }

        const variantPicker = this.content.querySelector('variant-picker');
        if (variantPicker && variantPicker.connectedCallback) {
          variantPicker.connectedCallback();
        }

        // Initialize quantity inputs
        this.content.querySelectorAll('quantity-input').forEach(input => {
          if (input.connectedCallback) input.connectedCallback();
        });
      }

      showError(message) {
        this.classList.add('is-open');
        this.setAttribute('aria-hidden', 'false');
        document.body.style.overflow = 'hidden';

        this.content.innerHTML = `
          <div class="quick-view-modal__error" style="padding: 2rem; text-align: center;">
            <p style="color: var(--color-error, #dc3545); margin-bottom: 1rem;">${message}</p>
            <button type="button" class="button" onclick="this.closest('quick-view-modal').close()">
              {{ 'accessibility.close' | t }}
            </button>
          </div>
        `;
      }

      async open(productUrl) {
        this.showLoading();

        try {
          const response = await fetch(`${productUrl}?section_id=quick-view`);
          if (!response.ok) throw new Error('Failed to load');

          const html = await response.text();

          // Parse and extract content
          const parser = new DOMParser();
          const doc = parser.parseFromString(html, 'text/html');
          const content = doc.querySelector('.quick-view__content')?.outerHTML
            || doc.querySelector('.shopify-section')?.innerHTML
            || html;

          this.show(content);
        } catch (error) {
          console.error('Quick view error:', error);
          this.showError('{{ "sections.cart.cart_error" | t | default: "Error loading product" }}');
        }
      }

      close() {
        this.classList.remove('is-open');
        this.setAttribute('aria-hidden', 'true');
        document.body.style.overflow = '';
        
        // Clear content after animation
        setTimeout(() => {
          this.content.innerHTML = `
            <div class="quick-view-modal__loading">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" stroke-dasharray="60" stroke-dashoffset="20"/>
              </svg>
            </div>
          `;
        }, 300);
      }
    }
    customElements.define('quick-view-modal', QuickViewModal);
  }

  // Global function to trigger quick view
  window.openQuickView = function(productUrl) {
    const modal = document.querySelector('quick-view-modal');
    if (modal) {
      modal.open(productUrl);
    }
  };
</script>
