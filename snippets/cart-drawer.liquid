{%- comment -%}
  LUMINA Theme - Cart Drawer Component
  AJAX cart drawer with dynamic updates
{%- endcomment -%}

<cart-drawer class="cart-drawer" id="cart-drawer" aria-modal="true" role="dialog" aria-label="{{ 'cart.title' | t }}">
  <div class="cart-drawer__overlay" data-cart-overlay></div>
  
  <div class="cart-drawer__container">
    {%- comment -%} Header {%- endcomment -%}
    <div class="cart-drawer__header">
      <h2 class="cart-drawer__title h4">
        {{ 'cart.title' | t }}
        <span class="cart-drawer__count">({{ cart.item_count }})</span>
      </h2>
      <button type="button" class="cart-drawer__close" data-cart-close aria-label="{{ 'accessibility.close' | t }}">
        {% render 'icons', icon: 'close', size: 24 %}
      </button>
    </div>

    {%- comment -%} Free Shipping Progress {%- endcomment -%}
    {%- assign free_shipping_threshold = settings.free_shipping_threshold | times: 100 -%}
    {%- if free_shipping_threshold > 0 -%}
      <div class="cart-drawer__shipping-progress">
        {%- assign remaining = free_shipping_threshold | minus: cart.total_price -%}
        {%- if remaining > 0 -%}
          {%- assign progress_percentage = cart.total_price | times: 100 | divided_by: free_shipping_threshold -%}
          <p class="cart-drawer__shipping-text">
            {{ 'cart.free_shipping_remaining' | t: amount: remaining | money_without_trailing_zeros }}
          </p>
        {%- else -%}
          {%- assign progress_percentage = 100 -%}
          <p class="cart-drawer__shipping-text cart-drawer__shipping-text--success">
            {% render 'icons', icon: 'check', size: 16 %}
            {{ 'cart.free_shipping_eligible' | t }}
          </p>
        {%- endif -%}
        <div class="cart-drawer__progress-bar">
          <div class="cart-drawer__progress-fill" style="width: {{ progress_percentage | at_most: 100 }}%"></div>
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} Cart Content {%- endcomment -%}
    <div class="cart-drawer__content" id="cart-drawer-content">
      {%- if cart.item_count > 0 -%}
        <form action="{{ routes.cart_url }}" method="post" id="cart-drawer-form">
          <ul class="cart-drawer__items" role="list">
            {%- for item in cart.items -%}
              <li class="cart-drawer__item" data-cart-item data-line="{{ forloop.index }}" data-key="{{ item.key }}">
                <div class="cart-drawer__item-image">
                  <a href="{{ item.url }}" tabindex="-1">
                    {%- if item.image -%}
                      {{ item.image | image_url: width: 150 | image_tag: 
                        loading: 'lazy',
                        widths: '75, 150',
                        sizes: '75px',
                        alt: item.image.alt | escape
                      }}
                    {%- else -%}
                      {{ 'product-1' | placeholder_svg_tag: 'placeholder-svg' }}
                    {%- endif -%}
                  </a>
                </div>

                <div class="cart-drawer__item-details">
                  <div class="cart-drawer__item-header">
                    <a href="{{ item.url }}" class="cart-drawer__item-title">
                      {{ item.product.title }}
                    </a>
                    <button type="button" 
                      class="cart-drawer__item-remove" 
                      data-remove-item
                      aria-label="{{ 'cart.remove' | t: title: item.title }}"
                    >
                      {% render 'icons', icon: 'trash', size: 18 %}
                    </button>
                  </div>

                  {%- if item.product.has_only_default_variant == false or item.properties.size > 0 -%}
                    <div class="cart-drawer__item-options">
                      {%- unless item.product.has_only_default_variant -%}
                        <span class="cart-drawer__item-variant">{{ item.variant.title }}</span>
                      {%- endunless -%}
                      
                      {%- for property in item.properties -%}
                        {%- assign property_first_char = property.first | slice: 0 -%}
                        {%- if property.last != blank and property_first_char != '_' -%}
                          <span class="cart-drawer__item-property">
                            {{ property.first }}: {{ property.last }}
                          </span>
                        {%- endif -%}
                      {%- endfor -%}
                    </div>
                  {%- endif -%}

                  <div class="cart-drawer__item-footer">
                    <quantity-input class="cart-drawer__quantity">
                      <button type="button" 
                        class="cart-drawer__quantity-btn" 
                        name="minus" 
                        aria-label="{{ 'cart.decrease' | t: title: item.title }}"
                      >
                        {% render 'icons', icon: 'minus', size: 14 %}
                      </button>
                      <input type="number" 
                        class="cart-drawer__quantity-input" 
                        name="updates[]" 
                        value="{{ item.quantity }}" 
                        min="0" 
                        max="{{ item.variant.inventory_quantity | default: 9999 }}"
                        aria-label="{{ 'cart.quantity' | t }}"
                        data-quantity-input
                      >
                      <button type="button" 
                        class="cart-drawer__quantity-btn" 
                        name="plus" 
                        aria-label="{{ 'cart.increase' | t: title: item.title }}"
                      >
                        {% render 'icons', icon: 'plus', size: 14 %}
                      </button>
                    </quantity-input>

                    <div class="cart-drawer__item-price">
                      {%- if item.original_line_price != item.final_line_price -%}
                        <span class="cart-drawer__price--sale">{{ item.final_line_price | money }}</span>
                        <span class="cart-drawer__price--compare">{{ item.original_line_price | money }}</span>
                      {%- else -%}
                        <span class="cart-drawer__price">{{ item.final_line_price | money }}</span>
                      {%- endif -%}

                      {%- if item.unit_price_measurement -%}
                        <span class="cart-drawer__unit-price">
                          {{ item.unit_price | money }}/{{ item.unit_price_measurement.reference_value }}{{ item.unit_price_measurement.reference_unit }}
                        </span>
                      {%- endif -%}
                    </div>
                  </div>

                  {%- for discount in item.line_level_discount_allocations -%}
                    <div class="cart-drawer__discount">
                      {% render 'icons', icon: 'tag', size: 14 %}
                      {{ discount.discount_application.title }}: -{{ discount.amount | money }}
                    </div>
                  {%- endfor -%}
                </div>

                <div class="cart-drawer__item-loader" data-item-loader hidden>
                  {% render 'icons', icon: 'spinner', size: 24 %}
                </div>
              </li>
            {%- endfor -%}
          </ul>
        </form>
      {%- else -%}
        <div class="cart-drawer__empty">
          {% render 'icons', icon: 'cart', size: 64 %}
          <p class="cart-drawer__empty-text">{{ 'cart.empty' | t }}</p>
          <a href="{{ routes.all_products_collection_url }}" class="btn btn--primary">
            {{ 'cart.continue_shopping' | t }}
          </a>
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Cart Footer {%- endcomment -%}
    {%- if cart.item_count > 0 -%}
      <div class="cart-drawer__footer">
        {%- comment -%} Cart Level Discounts {%- endcomment -%}
        {%- if cart.cart_level_discount_applications.size > 0 -%}
          <div class="cart-drawer__discounts">
            {%- for discount in cart.cart_level_discount_applications -%}
              <div class="cart-drawer__discount-line">
                <span>{{ discount.title }}</span>
                <span>-{{ discount.total_allocated_amount | money }}</span>
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}

        {%- comment -%} Subtotal {%- endcomment -%}
        <div class="cart-drawer__subtotal">
          <span class="cart-drawer__subtotal-label">{{ 'cart.subtotal' | t }}</span>
          <span class="cart-drawer__subtotal-price" id="cart-drawer-subtotal">{{ cart.total_price | money }}</span>
        </div>

        <p class="cart-drawer__taxes-note">
          {{ 'cart.taxes_and_shipping_at_checkout' | t }}
        </p>

        {%- comment -%} Cart Note {%- endcomment -%}
        {%- if settings.cart_note_enable -%}
          <div class="cart-drawer__note">
            <label for="cart-note" class="cart-drawer__note-label">
              {{ 'cart.note' | t }}
            </label>
            <textarea id="cart-note" 
              class="cart-drawer__note-input" 
              name="note" 
              placeholder="{{ 'cart.note_placeholder' | t }}"
            >{{ cart.note }}</textarea>
          </div>
        {%- endif -%}

        {%- comment -%} Checkout Button {%- endcomment -%}
        <div class="cart-drawer__actions">
          <a href="{{ routes.cart_url }}" class="btn btn--secondary cart-drawer__view-cart">
            {{ 'cart.view_cart' | t }}
          </a>
          <button type="submit" 
            form="cart-drawer-form" 
            name="checkout" 
            class="btn btn--primary cart-drawer__checkout"
          >
            {{ 'cart.checkout' | t }}
          </button>
        </div>

        {%- comment -%} Trust Badges {%- endcomment -%}
        <div class="cart-drawer__trust">
          <div class="cart-drawer__trust-item">
            {% render 'icons', icon: 'lock', size: 16 %}
            <span>{{ 'cart.secure_checkout' | t }}</span>
          </div>
          <div class="cart-drawer__trust-item">
            {% render 'icons', icon: 'truck', size: 16 %}
            <span>{{ 'cart.fast_shipping' | t }}</span>
          </div>
        </div>
      </div>
    {%- endif -%}

    {%- comment -%} Loading State {%- endcomment -%}
    <div class="cart-drawer__loading" id="cart-drawer-loading" hidden>
      {% render 'icons', icon: 'spinner', size: 40 %}
    </div>
  </div>
</cart-drawer>
