{{ 'section-product-recommendations.css' | asset_url | stylesheet_tag }}

<div class="product-recommendations section-{{ section.id }}-padding" data-product-recommendations data-product-id="{{ product.id }}" data-limit="{{ section.settings.products_to_show }}">
  <div class="page-width">
    {% if section.settings.heading != blank %}
      <h2 class="product-recommendations__title h2">{{ section.settings.heading }}</h2>
    {% endif %}

    <div class="product-recommendations__grid product-grid" style="--columns-desktop: {{ section.settings.desktop_columns }}; --columns-mobile: {{ section.settings.mobile_columns }};">
      {% if recommendations.performed and recommendations.products_count > 0 %}
        {% for product in recommendations.products %}
          <div class="product-recommendations__item">
            {% render 'product-card', product: product, show_vendor: section.settings.show_vendor %}
          </div>
        {% endfor %}
      {% endif %}
    </div>
  </div>
</div>

<script>
  (function() {
    const container = document.querySelector('[data-product-recommendations]');
    if (!container) return;

    const productId = container.dataset.productId;
    const limit = container.dataset.limit;

    if (!productId) return;

    fetch(`/recommendations/products.json?product_id=${productId}&limit=${limit}`)
      .then(response => response.json())
      .then(data => {
        if (data.products && data.products.length > 0) {
          const grid = container.querySelector('.product-recommendations__grid');
          grid.innerHTML = '';

          data.products.forEach(product => {
            const card = document.createElement('div');
            card.className = 'product-recommendations__item';
            card.innerHTML = `
              <a href="${product.url}" class="product-card">
                <div class="product-card__image-wrapper">
                  ${product.featured_image ? `<img src="${product.featured_image}" alt="${product.title}" class="product-card__image" loading="lazy">` : '<div class="product-card__placeholder"></div>'}
                </div>
                <div class="product-card__info">
                  <h3 class="product-card__title">${product.title}</h3>
                  <div class="product-card__price">${Shopify.formatMoney ? Shopify.formatMoney(product.price) : '$' + (product.price / 100).toFixed(2)}</div>
                </div>
              </a>
            `;
            grid.appendChild(card);
          });
        } else {
          container.style.display = 'none';
        }
      })
      .catch(() => {
        container.style.display = 'none';
      });
  })();
</script>

{% schema %}
{
  "name": "Product recommendations",
  "tag": "section",
  "class": "section-product-recommendations",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "default": "You May Also Like",
      "label": "Heading"
    },
    {
      "type": "range",
      "id": "products_to_show",
      "min": 2,
      "max": 12,
      "step": 1,
      "default": 4,
      "label": "Products to show"
    },
    {
      "type": "range",
      "id": "desktop_columns",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4,
      "label": "Columns on desktop"
    },
    {
      "type": "select",
      "id": "mobile_columns",
      "options": [
        { "value": "1", "label": "1" },
        { "value": "2", "label": "2" }
      ],
      "default": "2",
      "label": "Columns on mobile"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "default": false,
      "label": "Show vendor"
    }
  ],
  "presets": [
    {
      "name": "Product recommendations"
    }
  ]
}
{% endschema %}
